# Интеграция SQLite в Pechkin

## Описание проекта
Pechkin — это Ruby-гем для отправки сообщений в различные мессенджеры через HTTP-запросы. Конфигурация проекта включает описание ботов, каналов и шаблонов сообщений.

### Основные сущности:
- **Bot**: Содержит токен и тип коннектора (Telegram, Slack).
- **Channel**: Определяет группу сообщений, привязанного бота и список ID чатов для отправки.
- **Message**: Связывает канал с шаблоном, содержит переменные и фильтры.
- **View (Template)**: ERB-шаблон для формирования текста сообщения.

## Текущее состояние
Конфигурации загружаются из файловой системы (папки `bots/`, `channels/`, `views/`). Загрузка реализована в модулях `Pechkin::ConfigurationLoader*`.

## Цель
Добавить поддержку хранения и загрузки конфигураций из базы данных SQLite с использованием ActiveRecord.

## План интеграции

### 1. Подготовка зависимостей
- Добавить `activerecord` и `sqlite3` в `Gemfile`.
- Выполнить `bundle install`.

### 2. Проектирование схемы БД
Необходимо создать следующие таблицы:
- `bots`: `id`, `name` (unique), `token`, `connector`.
- `views`: `id`, `name` (unique), `content`.
- `channels`: `id`, `name` (unique), `chat_ids` (string/json), `bot_id` (FK to bots).
- `messages`: `id`, `channel_id` (FK to channels), `view_id` (FK to views, nullable), `name` (unique per channel), `variables` (json), `filters` (json), `config` (json).
- `channels_views`: Таблица для связи "многие ко многим" (если требуется явная связь каналов и шаблонов помимо сообщений). *Уточнение: согласно задаче, канал может иметь много шаблонов, и шаблоны — много каналов.*

### 3. Инфраструктура БД (lib/pechkin/db.rb)
- Реализовать подключение к SQLite.
- Путь к базе: текущая директория или из переменной окружения (например, `PECHKIN_DB_PATH`).
- Автоматическое создание таблиц при запуске (миграции или `ActiveRecord::Schema.define`).

### 4. Создание моделей ActiveRecord (lib/pechkin/db/models.rb)
- `Pechkin::DB::Bot`
- `Pechkin::DB::View`
- `Pechkin::DB::Channel`
- `Pechkin::DB::Message`
- Настройка связей:
    - `Channel belongs_to :bot`
    - `Bot has_many :channels`
    - `Channel has_many :messages`
    - `Message belongs_to :view`
    - `Channel has_many :views, through: :messages` (для реализации связи многие-ко-многим через сообщения).

### 5. Реализация загрузчика из БД (lib/pechkin/configuration/db_loader.rb)
- Создать класс `Pechkin::DBLoader`, который будет вычитывать данные из БД и преобразовывать их в объекты, используемые в `Pechkin::Configuration` (`Bot`, `Channel`, `MessageTemplate`).

### 6. Интеграция в Pechkin::Configuration
- Изменить `Pechkin::Configuration.load_from_directory` так, чтобы после загрузки с диска вызывалась загрузка из БД.
- Реализовать логику мерджа: данные из БД должны перезаписывать данные с диска при совпадении имен (ключей).

### 7. Тестирование и верификация
- Создать тестовую БД.
- Проверить, что конфигурации из БД корректно подгружаются и имеют приоритет.
- Убедиться, что старый функционал (загрузка только с диска) продолжает работать.

## Особенности реализации
- Использование `arel_table` для построения запросов (по требованию).
- Использование ActiveRecord для работы с данными.
- Поддержка любой другой БД через конфигурацию (ActiveRecord это позволяет из коробки).
